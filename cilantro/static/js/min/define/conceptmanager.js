define(["cilantro/define/view"],function(a){function O(a,b,d,e){c.fadeIn();parseInt(a.id,10)!==k&&(b&&(a.query=b),k!==null&&(h[k]["static"]=g.children().detach()),h[a.id]&&h[a.id].globalsLoaded?L(a):K(a,L))}function N(a){h[a.id]===undefined?h[a.id]=a:($.extend(h[a.id],a),a=h[a.id]),a.ds||(a.query?a.ds=A(a.query):a.ds={}),a.invalid_fields||(a.invalid_fields={});return a}function M(a,b){var c=e.children().index(b);e.trigger("ShowViewEvent",c)}function L(a){a=N(a),k=parseInt(a.id,10),a.globalsLoaded=!0,a.views.length<2?e.hide():e.show();var b=$.jqote(i,a.views);e.html(b),a["static"]?(g.append(a["static"]),m=g.find("#add_to_query")):(g.append(j),m=g.find("#add_to_query"),m.click(function(){var a=$.Event("UpdateQueryButtonClicked");$(this).trigger(a);return!1})),$.inArray(k,n)<0?(m.html('<span class="icon plus"/> <span>Add Condition</span>'),$(".success",g).hide()):(m.html('<span class="icon refresh"/> <span>Update Condition</span>'),$(".success",g).show()),e.children(":first").click()}function K(b,c){c=c||function(){},b.css&&a.loadCss(b.css),b.js?require([b.js],function(a){c(b)}):c(b)}function J(a){a.reason=a.reason?"_"+a.reason:"";var b=h[k].invalid_fields,c=$(a.target).attr("name");$.each(h[k].views,function(b,d){d.contents&&d.contents.dom().find("[name="+c+"]").removeClass("invalid"+a.reason),d.contents&&d.contents.dom().find("[name="+c+"]").children().removeClass("invalid"+a.reason)});var d=b[c+a.reason].data("ref_count")-1;d===0?b[c+a.reason].remove():b[c+a.reason].data("ref_count",d),delete h[k].invalid_fields[c+a.reason],$.isEmptyObject(h[k].invalid_fields)&&g.find("#add_to_query").attr("disabled","")}function I(a){a.reason=a.reason?"_"+a.reason:"";var b=h[k].invalid_fields,c=$(a.target).attr("name");$.each(h[k].views,function(b,d){d.contents&&d.contents.dom().find("[name="+c+"]").addClass("invalid"+a.reason),d.contents&&d.contents.dom().find("[name="+c+"]").children().addClass("invalid"+a.reason)});var d=a.message?a.message:"This query contains invalid input, please correct any invalid fields.",e=!1;$.each(g.find(".error"),function(f,g){g=$(g);var h=g.data("ref_count");if(g.text()===d){e=!0;if(a.ephemeral)return;if(b[c+a.reason]===undefined)b[c+a.reason]=g,g.data("ref_count",h+1);else if(g.text()!==b[c+a.reason].text()){var i=b[c+a.reason].data("ref_count");b[c+a.reason].data("ref_count",i-1),b[c+a.reason].data("ref_count")===0&&b[c+a.reason].remove(),b[c+a.reason]=g,g.data("ref_count",h+1)}}});if(!e){var f=$('<div class="message error">'+d+"</div>");f.data("ref_count",1),a.ephemeral||(b[c+a.reason]=f),g.prepend(f),a.ephemeral?f.fadeOut(3e3,function(){f.remove()}):g.find("#add_to_query").attr("disabled","true")}}function H(a){$(l.contents).triggerHandler("UpdateQueryButtonClicked")}function G(a,b){b=b||h[k].ds;if(!F(b)){var c=$.Event("InvalidInputEvent");c.ephemeral=!0,c.message="No value has been specified.",$(a.target).trigger(c);return!1}var d=z(b);$(a.target).trigger("UpdateQueryEvent",[d]);return!0}function F(a){var b=!1;if($.isEmptyObject(a))b=!0;else{b=!0;for(var c in a){if(!a.hasOwnProperty(c))continue;if(q.test(c)){if(a[c]&&a[c].indexOf("isnull")>=0){b=!1;break}}else if(r.test(c)||p.test(c)||o.test(c)){b=!1;break}}}if(b)return!1;for(var c in a){if(!a.hasOwnProperty(c))continue;if(a[c]===undefined||a[c]==="")return!1;if($.isArray(a[c])&&a[c].length===0)return!1}return!0}function E(a,b){var c=h[k].ds,d=!1;if(b.value instanceof Array||c[b.name]!==b.value){if(b.value instanceof Array&&c[b.name]instanceof Array){for(var e=0;e<b.value.length;e++)if($.inArray(b.value[e],c[b.name])==-1){d=!0;break}if(d===!1&&b.value.length==c[b.name].length)return}b.value===undefined?delete h[k].ds[b.name]:h[k].ds[b.name]=b.value instanceof Array?b.value.slice(0):b.value,$.each(h[k].views,function(a,c){l!==c&&c.contents&&c.contents.trigger("UpdateElementEvent",[b])})}}function D(a,b){}function C(b,d){l!==null&&(l.contents.dom().css("display","none"),$(l.contents).trigger("LostFocusEvent"),l.contents.dom().detach()),l=h[k].views[d];if(l.loaded)B(null,l.contents);else{var e=null;l.concept_id=k,c.fadeIn().trigger("ViewReadyEvent",[new a(l,h[k].name)])}}function B(a,b){l.contents=b;var c=l.contents.dom();f.append(c),c.css("display","block"),$(".chart",l.contents).css("display","block"),l.loaded||($(b).trigger("UpdateDSEvent",[h[k].ds]),$(b).trigger("RegisterElementsEvent")),$(b).trigger("GainedFocusEvent"),l.loaded=!0}function A(a,b){var c=b||{},d,e;if(a.hasOwnProperty("type"))$.each(a.children,function(a,b){A(b,c)});else{a.hasOwnProperty("id_choices")?(e=a.id_choices.join("OR"),c[e]=a.id):e=a.id,d=a.concept_id+"_"+e;if(!a.operator.match(/null/))if(a.datatype in{number:1,date:1}){var f=a.value instanceof Array?a.value:[a.value];for(var g=0;g<f.length;g++)c[d+"_input"+g]=f[g]}else c.hasOwnProperty(d)?c[d]instanceof Array?c[d].push(a.value):(c[d]=[c[d]],c[d].push(a.value)):c[d]=a.value;c[d+"_operator"]=c[d]instanceof Array&&a.datatype&&a.datatype.indexOf("boolean")>=0?u[a.operator]:a.operator}return c}function z(a){var b={};for(var c in a){if(!a.hasOwnProperty(c))continue;var d=p.exec(c);if(d){b.hasOwnProperty(d[2])?$.extend(b[d[2]],{val0:a[c],val1:undefined,op:undefined}):b[d[2]]={val0:a[c],val1:undefined,op:undefined};continue}d=o.exec(c);if(d){b.hasOwnProperty(d[2])?b[d[2]]["val"+d[3]]=Number(a[c])||a[c]:(b[d[2]]={val0:undefined,val1:undefined,op:undefined},b[d[2]]["val"+d[3]]=Number(a[c])||a[c]);continue}d=r.exec(c),d&&(b.hasOwnProperty(d[0])?b[d[0]].pk=a[c]:b[d[0]]={val0:undefined,val1:undefined,op:undefined,pk:a[c]})}for(c in a){if(!a.hasOwnProperty(c))continue;d=q.exec(c),d&&(b[d[2]]||a[c].match(/null/))&&(b.hasOwnProperty(d[2])||(b[d[2]]={val0:undefined,val1:undefined,op:undefined}),b[d[2]].op=a[c])}var e=[];for(var f in b){var g=b[f],h=!1,i=null;r.exec(f)&&(i=f.split("OR"),f=g.pk,h=!0),f=Number(f);if(g.val0===undefined&&g.val1===undefined&&g.op!==undefined)e.push({operator:g.op,id:f,concept_id:k,value:!0,datatype:y(f)});else if(g.val0!==undefined&&g.val1!==undefined&&g.op!==undefined)e.push({operator:g.op,id:f,value:[g.val0,g.val1],concept_id:k,datatype:y(f)});else if(g.val0===undefined||g.op===undefined||g.val0 instanceof Array)if(g.val0!==undefined&&g.val0 instanceof Array){g.op=g.op!==undefined?g.op:"in";var j=y(f);switch(j){case"boolean":case"nullboolean":var m=[],n=t[g.op];$.each(g.val0,function(a,b){m.push({operator:n,id:f,value:v[b]!==undefined?v[b]:b,concept_id:k,datatype:j})}),m.length>1?e.push({type:s.test(g.op)?"and":"or",children:m,concept_id:k}):e.push(m[0]);break;default:e.push({operator:g.op,id:f,value:g.val0,concept_id:k})}}else{if(g.val0===undefined||g.val0 instanceof Array||g.val1!==undefined)throw"Unable to determine field "+g+" in concept "+k;e.push({operator:"exact",id:f,value:g.val0,concept_id:k})}else e.push({operator:g.op,id:f,value:g.val0,concept_id:k,datatype:y(f)});h&&(e[e.length-1].id_choices=i)}var u;e.length===1?u=e[0]:u={type:l.join_by||"and",children:e,concept_id:k};return u}function y(a){var b=l.elements,c=null;$.each(b,function(b,d){if(d.type==="custom")return d.datatype;if(d.data){if(d.data.pk==a){c=d.data.datatype;return!1}if(d.data.pkchoices&&$.inArray(a,$.map(d.data.pkchoices,function(a,b){return a[0]}))>=0){c=d.data.datatype;return!1}}else{$.each(d.fields,function(b,d){if(d.pk==a){c=d.datatype;return!1}if(d.pkchoices&&$.inArray(a,$.map(d.pkchoices,function(a,b){return a[0]}))>=0){c=d.datatype;return!1}});if(c!==null)return!1}});return c}function x(a){var b=$.inArray(parseInt(a.concept_id,10),n);b>=0&&(n.splice(b,1),k===parseInt(a.concept_id,10)&&(m.html('<span class="icon plus"/> <span>Add Condition</span>'),$(".success",g).hide())),a.stopPropagation()}function w(a){$.inArray(a.concept_id,n)<0&&(n.push(parseInt(a.concept_id,10)),k===parseInt(a.concept_id,10)&&(m.html('<span class="icon refresh"/> <span>Update Condition</span>'),$(".success",g).show())),a.stopPropagation()}var b={},c=$("#plugin-panel"),d=$("#plugin-title"),e=$("#plugin-tabs"),f=$("#plugin-dynamic-content"),g=$("#plugin-static-content"),h={},i='<a class="tab" href="#"><%= this.tabname %></a> ',j=['<div class="message success">Condition has been added.</div>','<button id="add_to_query"></button>'].join(""),k=null,l=null,m=null,n=[],o=/^(\d+)_(\d+(?:OR\d+)*)_input([01])$/,p=/^(\d*)_(\d+(?:OR\d+)*)$/,q=/^(\d*)_(\d+(?:OR\d+)*)_operator$/,r=/^\d+(?:OR\d+)+$/,s=/-/,t={"in":"exact","-in":"-exact",exact:"exact","-exact":"-exact"},u={exact:"in","-exact":"-in"},v={"true":!0,"false":!1,"null":null};c.bind({ViewReadyEvent:B,ViewErrorEvent:D,ShowViewEvent:C,ElementChangedEvent:E,UpdateQueryButtonClicked:H,InvalidInputEvent:I,InputCorrectedEvent:J,ConstructQueryEvent:G,ConceptDeletedEvent:x,ConceptAddedEvent:w}),e.bind("ConceptTabClickedEvent",M),e.tabs(!0,function(a,b){b.trigger("ConceptTabClickedEvent",b)});return{show:O,isConceptLoaded:function(a){return a in h},buildQuery:z,constructQueryHandler:G}})